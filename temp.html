<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>RSO w Search</title>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- MapTiler Geocoding CSS & JS -->
    <script src="https://cdn.maptiler.com/maptiler-geocoding-control/v1.3.3/leaflet.umd.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-geocoding-control/v1.3.3/style.css" rel="stylesheet">

    <!-- Data Source -->
    <script src="data/education/unis_public.js"></script>

    <!-- Marker Cluster CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- MGRS Conversion JS -->
    <script src="https://cdn.jsdelivr.net/npm/mgrs@2.0.0/dist/mgrs.min.js"></script>

    <!-- Inline Styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>
    <h2 style="margin-bottom:0; margin-top: 0; text-align:center">RSO - Addis Ababa</h2>
    <h5 style="margin-bottom:0; margin-top:0; text-align: center;">(UNCLASS / Open Source)</h5>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Script for Map Initialization and Layers -->
    <script>
        const key = 'OC3KF0W4ulmkXInrrDn5';
        const map = L.map('map').setView([9.15, 40.49], 7);

        // Base Map Tile Layer
        const MapTileLayer = L.tileLayer(`https://api.maptiler.com/maps/openstreetmap/{z}/{x}/{y}.jpg?key=${key}`, {
            tileSize: 512,
            zoomOffset: -1,
            minZoom: 5,
            maxZoom: 18,
            attribution: "&copy; <a href='https://www.maptiler.com/copyright/' target='_blank'>MapTiler</a> &copy; <a href='https://www.openstreetmap.org/copyright' target='_blank'>OpenStreetMap contributors</a>",
            crossOrigin: true
        }).addTo(map);

        // Geocoding Control
        L.control.maptilerGeocoding({ apiKey: key }).addTo(map);

        // Layer Groups
        var refGeoJSON = L.layerGroup();
        var refRegion = L.layerGroup();
        var refLATLNGMGRS = L.layerGroup();

        refGeoJSON.addTo(map); // Add Woredas by default

        // Function to load GeoJSON dynamically
        function loadGeoJSON(layer, url, layerType) {
            layer.clearLayers();  // Clear layer before adding new data

            fetch(url)
                .then(response => response.ok ? response.json() : Promise.reject('Failed to load GeoJSON'))
                .then(data => {
                    L.geoJSON(data, {
                        style: feature => {
                            return layerType === 'Regions' ? {
                                color: "green",
                                weight: 1.0,
                                opacity: 0.5,
                                fillColor: "#a1e3a1",
                                fillOpacity: 0.1
                            } : {
                                color: "purple",
                                weight: 0.8,
                                opacity: 0.25,
                                fillColor: "#e2fdff",
                                fillOpacity: 0.1
                            };
                        },
                        onEachFeature: (feature, layer) => {
                            let popupContent = '';
                            if (feature.properties) {
                                popupContent = Object.entries(feature.properties)
                                    .map(([key, value]) => `<b>${key}:</b> ${value}`)
                                    .join('<br/>');

                                layer.on('mouseover', () => layer.bindPopup(popupContent).openPopup());
                                layer.on('mouseout', () => layer.closePopup());
                            }
                        }
                    }).addTo(layer);
                })
                .catch(error => console.error('Error loading GeoJSON:', error));
        }

        // ACLED Data Layer Configuration
        const daySpan = 30;
        const today = new Date();
        const DaysAgo = new Date();
        DaysAgo.setDate(today.getDate() - daySpan);
        const todayStr = today.toISOString().split('T')[0];
        const DaysAgoStr = DaysAgo.toISOString().split('T')[0];

        const apiURL = `https://api.acleddata.com/acled/read/?key=ujtQHEeGFTEfGG3BIBGS&email=davisse@fan.gov&iso=231|729&event_date=${DaysAgoStr}|${todayStr}&event_date_where=BETWEEN`;
        const refACLED = L.layerGroup();
        const acledMarkers = L.markerClusterGroup();

        fetch(apiURL)
            .then(response => response.json())
            .then(jsonData => {
                jsonData.data.forEach(event => {
                    const latlng = [parseFloat(event.latitude), parseFloat(event.longitude)];
                    const circleMarker = L.circleMarker(latlng, { radius: 10, color: 'red', weight: 2, fill: true })
                        .bindPopup(`${event.event_date}<br/>${event.sub_event_type}<br/>${event.notes}`);
                    acledMarkers.addLayer(circleMarker);
                });
                refACLED.addLayer(acledMarkers);
            })
            .catch(error => console.error('Error fetching ACLED data:', error));

        // Base Layer Tile Configuration
        const googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });

        const googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });

        const googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });

        // Layer Control Configuration
        const baseMaps = {
            "OpenStreetMap": MapTileLayer,
            "Satellite": googleSat,
            "Streets": googleStreets,
            "Terrain": googleTerrain
        };

        const overlays = {
            "Woredas": refGeoJSON,
            "Regions": refRegion,
            "ACLED Last 30 Days": refACLED
        };

        L.control.layers(baseMaps, overlays).addTo(map);
    </script>
</body>

</html>
