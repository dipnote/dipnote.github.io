<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSO w Search</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.maptiler.com/maptiler-geocoding-control/v1.3.3/leaflet.umd.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-geocoding-control/v1.3.3/style.css" rel="stylesheet">

    <!-- Data Src -->
    <script src="data/education/unis_public.js"> </script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>
    <h2 style="margin-bottom:0; margin-top: 0;text-align:center">RSO - Addis Ababa</h2>
    <h5 style="margin-bottom:0; margin-top:0; text-align: center;">(UNCLASS / Open Source)</h5>
    <div id="map"></div>

    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mgrs@2.0.0/dist/mgrs.min.js"></script>

</body>

<script>
    const key = 'OC3KF0W4ulmkXInrrDn5';

    const map = L.map('map').setView([9.15, 40.49], 7);
    const MapTileLayer = L.tileLayer(`https://api.maptiler.com/maps/openstreetmap/{z}/{x}/{y}.jpg?key=${key}`, {
        tileSize: 512,
        zoomOffset: -1,
        minZoom: 5,
        maxZoom: 18,
        attribution: "\u003ca href=\"https://www.maptiler.com/copyright/\" target=\"_blank\"\u003e\u0026copy; MapTiler\u003c/a\u003e \u003ca href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\"\u003e\u0026copy; OpenStreetMap contributors\u003c/a\u003e",
        crossOrigin: true,
    }).addTo(map);

    L.control.maptilerGeocoding({ apiKey: key }).addTo(map);

    // Defining layers
    var refGeoJSON = L.layerGroup();
    var refRegion = L.layerGroup();
    var refLATLNGMGRS = L.layerGroup();
    var refAFCP = L.layerGroup();
    var refUnivPublic = L.layerGroup();
    var refAirport = L.layerGroup();
    var amSpaces = L.layerGroup();
    var refPOI = L.layerGroup();

    refGeoJSON.addTo(map);

    // Function to get date range string for any given number of days ago
    let today = new Date();

    function getDateRangeStr(daysAgo) {
        let daysAgoDate = new Date(today);  // Copy the current date
        daysAgoDate.setDate(today.getDate() - daysAgo);

        let todayStr = today.toISOString().split('T')[0];
        let daysAgoStr = daysAgoDate.toISOString().split('T')[0];
        return { todayStr, daysAgoStr };
    }

    // RSI Data Layer (from uploaded GeoJSON file)
    var refRSI = L.layerGroup();
    var rsiMarkers = L.markerClusterGroup();

    // Function to load and filter incidents based on the day span
    function loadIncidentsData(layerGroup, daySpan) {
        let dateRange = getDateRangeStr(daySpan);

        layerGroup.clearLayers();

        fetch('data/conflict/220714-241130-incidents-all.geojson')
            .then(response => response.json())
            .then(jsonData => {
                const incidents = jsonData.features;
                for (const incident of incidents) {
                    const incidentDate = new Date(incident.properties.IncidentDate);
                    const startDate = new Date(dateRange.daysAgoStr);
                    const endDate = new Date(dateRange.todayStr);

                    // Check if incident date is within the desired range
                    if (incidentDate >= startDate && incidentDate <= endDate) {
                        const latlng = [
                            parseFloat(incident.geometry.coordinates[1]),
                            parseFloat(incident.geometry.coordinates[0])
                        ];
                        const properties = incident.properties;

                        var circleMarker = L.circleMarker(latlng, {
                            radius: 10,
                            color: 'blue',
                            weight: 2,
                            fill: true
                        }).bindPopup(
                            properties.IncidentDate + '</br>' +
                            properties.IncidentType + '</br>Deaths: ' +
                            properties.DeathCount + '</br>' +
                            properties.Description
                        );

                        rsiMarkers.addLayer(circleMarker);
                    }
                    refRSI.addLayer(rsiMarkers);
                }
            })
            .catch(error => console.error('Error loading RSI data:', error));
    }

    // Create layers for each day span
    var incidents30Layer = L.layerGroup();
    var incidents60Layer = L.layerGroup();
    var incidents90Layer = L.layerGroup();

    loadIncidentsData(incidents30Layer, 30);
    loadIncidentsData(incidents60Layer, 60);
    loadIncidentsData(incidents90Layer, 90);

    // Define airport markers
    const airportIcon = new L.icon({
        iconUrl: 'https://api.geoapify.com/v1/icon/?type=awesome&scaleFactor=1&color=%2372a2d4&size=small&icon=plane-departure&apiKey=' + key,
        cursor: 'pointer',
        anchor: 'bottom',
        offset: [0, 6]
    });

    L.marker([8.97789, 38.799301], { icon: airportIcon }).bindPopup('<p>Bole Airport<br/>IATA:ADD / ICAO:HAAB<br/>3,800m / 12,467f</p>').addTo(refAirport);
    L.marker([11.6081, 37.3216], { icon: airportIcon }).bindPopup("<p>BJR<br/>Bahir Dar Airport</p>").addTo(refAirport);
    L.marker([12.52038, 37.43385], { icon: airportIcon }).bindPopup("<p>GDQ<br/>Gonder Airport</p>").addTo(refAirport);

    // Define markers for AFCP (Amb Fund Cult Pres) locations
    const afcpIcon = new L.Icon({
        iconUrl: 'https://api.geoapify.com/v1/icon/?type=material&color=%23325acb&size=large&icon=landmark&iconType=awesome&scaleFactor=2&apiKey=' + key,
        iconSize: [24, 40],
        iconAnchor: [5, 18]
    });

    L.marker([13.8580, 39.4302], { icon: afcpIcon }).bindPopup('<p>Debra Tsion Church<br/>2020</p>').addTo(refAFCP);
    L.marker([7.701226, 36.872284], { icon: afcpIcon }).bindPopup('<p>Aba Jiffar Palace<br/>2018</p>').addTo(refAFCP);
    L.marker([12.03161, 39.0411], { icon: afcpIcon }).bindPopup('<p>Lalibela Churches<br/>2016</p>').addTo(refAFCP);

    // Example data for public universities
    const univIcon = new L.icon({
        iconUrl: 'https://example.com/university-icon.png', // Replace with your own icon URL
        iconSize: [30, 30],
        iconAnchor: [15, 30],
    });

    L.marker([9.0150, 38.7432], { icon: univIcon }).bindPopup("<p>University 1</p>").addTo(refUnivPublic);
    L.marker([8.9750, 38.7940], { icon: univIcon }).bindPopup("<p>University 2</p>").addTo(refUnivPublic);

    // Add overlays to the map layer control
    var overlays = {
        "Incidents 30 Days": incidents30Layer,
        "Incidents 60 Days": incidents60Layer,
        "Incidents 90 Days": incidents90Layer,
        "Woredas": refGeoJSON,
        "Regions": refRegion,
        "Airports": refAirport,
        "Amb Fund Cult Pres": refAFCP,
        "Public Universities": refUnivPublic,
        "American Spaces": amSpaces,
        "LAT-LNG-MGRS": refLATLNGMGRS,
        "Places of Interest": refPOI
    };

    var baseMaps = {
        "OpenStreetMap": MapTileLayer,
    };

    L.control.layers(baseMaps, overlays, { collapsed: true }).addTo(map);

    // Load initial GeoJSON data for Woredas and Regions
    function loadGeoJSON(layer, url) {
        fetch(url)
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data).addTo(layer);
            })
            .catch(error => console.error('Error loading GeoJSON:', error));
    }

    loadGeoJSON(refGeoJSON, 'data/adminLevels/ET-admin3_2023.geojson');
    loadGeoJSON(refRegion, 'data/adminLevels/ET_admin1_2023.geojson');
</script>

</html>